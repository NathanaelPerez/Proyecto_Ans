{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Editar Perfil{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="card mx-auto shadow" style="max-width: 700px; border-radius: 1rem; background: linear-gradient(135deg, #ffffff, #f9f9f9);">
        <div class="card-body">
            <h3 class="text-center mb-4" style="color: #2575fc;">Editar mi Perfil</h3>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {{ form.non_field_errors }}

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="id_username" class="form-label">Usuario</label>
                        {{ form.username|add_class:"form-control" }}
                    </div>

                    <div class="col-md-6">
                        <label for="id_email" class="form-label">Correo electrónico</label>
                        {{ form.email|add_class:"form-control" }}
                    </div>

                    <div class="col-md-6">
                        <label for="id_nombres" class="form-label">Nombres</label>
                        {{ form.nombres|add_class:"form-control" }}
                    </div>

                    <div class="col-md-6">
                        <label for="id_apellidos" class="form-label">Apellidos</label>
                        {{ form.apellidos|add_class:"form-control" }}
                    </div>

                    <div class="col-md-6">
                        <label for="id_carrera" class="form-label">Carrera</label>
                        {{ form.carrera|add_class:"form-control" }}
                    </div>

                    <div class="col-md-6">
                        <label for="id_carnet" class="form-label">Carnet</label>
                        {{ form.carnet|add_class:"form-control" }}
                    </div>

                    <div class="col-md-6">
                        <label for="id_ciclo" class="form-label">Ciclo</label>
                        {{ form.ciclo|add_class:"form-control" }}
                    </div>

                    <!-- FOTO DE PERFIL -->
                    <div class="col-md-6">
                        <label class="form-label">Foto de perfil</label>

                        <div class="d-flex align-items-center gap-2">
                            <!-- Input real oculto -->
                            <input type="file" name="{{ form.foto_perfil.name }}" id="id_foto_perfil" class="d-none" onchange="updateFileName()" />

                            <!-- Botón personalizado -->
                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('id_foto_perfil').click();">
                                Seleccionar archivo
                            </button>

                            <!-- Texto del nombre del archivo -->
                            <span id="file-name" class="text-muted text-truncate" style="max-width: 200px;">
                                {% if perfil.foto_perfil %}
                                    {{ perfil.foto_perfil.name|slice:"12:" }}
                                {% else %}
                                    Ningún archivo seleccionado
                                {% endif %}
                            </span>
                        </div>

                        <!-- Imagen previa -->
                        <img 
                            id="preview-img"
                            src="{% if perfil.foto_perfil %}{{ perfil.foto_perfil.url }}{% endif %}"
                            alt="Vista previa"
                            class="mt-3 d-block mx-auto"
                            style="max-width: 150px; border-radius: 0.5rem; {% if not perfil.foto_perfil %}display:none;{% endif %}"
                        >
                    </div>

                    <!-- CAMBIO DE CONTRASEÑA -->
                    <div class="col-12">
                        <label for="id_nueva_contrasena" class="form-label">Nueva contraseña</label>
                        <div class="input-group">
                            {{ form.nueva_contrasena|add_class:"form-control" }}
                            <button type="button" class="btn btn-outline-secondary" id="toggle-password">
                                <i class="fa fa-eye-slash" id="eye-icon"></i>
                            </button>
                        </div>
                        <small class="text-muted">Deja vacío si no quieres cambiar la contraseña.</small>
                    </div>
                </div>

                <!-- BOTÓN GUARDAR -->
                <div class="mt-4 text-center">
                    <button type="submit" class="btn btn-primary px-5">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JS -->
<script>
    // Alternar visibilidad de la contraseña
    document.addEventListener("DOMContentLoaded", function () {
        const toggleBtn = document.getElementById("toggle-password");
        const passwordInput = document.getElementById("id_nueva_contrasena");
        const eyeIcon = document.getElementById("eye-icon");

        toggleBtn.addEventListener("click", () => {
            const type = passwordInput.getAttribute("type");
            passwordInput.setAttribute("type", type === "password" ? "text" : "password");
            eyeIcon.classList.toggle("fa-eye");
            eyeIcon.classList.toggle("fa-eye-slash");
        });
    });

    // Actualizar nombre del archivo y mostrar vista previa
    function updateFileName() {
        const input = document.getElementById('id_foto_perfil');
        const fileNameDisplay = document.getElementById('file-name');
        const previewImg = document.getElementById('preview-img');

        if (input.files.length > 0) {
            const file = input.files[0];
            fileNameDisplay.textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            fileNameDisplay.textContent = 'Ningún archivo seleccionado';
            previewImg.style.display = 'none';
        }
    }
</script>
{% endblock %}
