{% extends 'base.html' %}
{% block title %}Método de Richardson | SolverPlus{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Método de Richardson</h2>

  <form method="post">
    {% csrf_token %}
    <div class="form-group">
      <label for="funcion">Función f(x):</label>
      <input type="text" name="expr" id="funcion" class="form-control" placeholder="Ej: sin(x), x**2 + 3*x" value="{{ expr|default:'' }}" required>
    </div>

    <div class="form-row row">
      <div class="form-group col-md-4">
        <label for="x">Valor de x:</label>
        <input type="number" step="any" name="x_val" id="x" class="form-control" value="{{ x_val|default:'' }}" required>
      </div>
      <div class="form-group col-md-4">
        <label for="h">Valor de h:</label>
        <input type="number" step="any" name="h_val" id="h" class="form-control" value="{{ h_val|default:'' }}" required>
      </div>
      <div class="form-group col-md-4">
        <label for="orden">Orden de la derivada:</label>
        <input type="number" name="order" id="orden" class="form-control" value="{{ order|default:'1' }}" min="1" max="4" required>
      </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Calcular</button>
  </form>

  {% if resultado %}
    <hr>
    
    {% if user.is_authenticated %}
      <div class="card p-3">
        <p><strong>Fórmula utilizada para la derivada de orden {{ order }}:</strong></p>
        <p>\[ {{ latex.0.1 }} \]</p>

        <p><strong>Función:</strong></p>
        <p>\[ f(x) = {{ expr }} \]</p>

        <p><strong>Error relativo calculado:</strong></p>
        <p>\[ \varepsilon_a = \left| \frac{D(h/2) - D(h)}{D(h/2)} \right| \times 100\% = {{ error }}\% \]</p>

        <p>Valor de la extrapolación:</p>
        {% for fila in latex %}
          {% if "Extrapolación" in fila.0 or "Sustituyendo" in fila.0 %}
            <p>\[ {{ fila.1 }} \]</p>
          {% endif %}
        {% endfor %}
      </div>

      <p><strong>Resultado final: {{ resultado }}</strong></p>

      <h4>Gráfica</h4>
      <img src="data:image/png;base64,{{ grafico }}" class="img-fluid" alt="Gráfica derivada">

      <a href="{% url 'descargar_pdf' %}?expr={{ expr|urlencode }}&x_val={{ x_val }}&h_val={{ h_val }}&order={{ order }}" class="btn btn-success mt-3">
        Descargar PDF
      </a>

    {% else %}
      <p><strong>Fórmula utilizada para la derivada de orden {{ order }}:</strong></p>
      <p>\[ {{ latex.0.1 }} \]</p>

      <p class="text-danger mt-3">Para ver los resultados completos, por favor inicia sesión.</p>
    {% endif %}
  {% endif %}
</div>

<!-- Cargar MathJax para renderizar fórmulas -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
{% endblock %}